name: Admin Desktop CI

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - 'AdminSide/**'

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        working-directory: ./AdminSide

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x 

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    # --- НОВИЙ КРОК ---
    # Додаємо бібліотеку, якої не вистачає для роботи з картинками/іконками
    - name: Fix Resources (Add Package)
      run: dotnet add USRest_Admin/USRest_Admin.csproj package System.Resources.Extensions

    - name: Restore Packages (Legacy)
      run: nuget restore USRest_Admin.sln

    # --- ОНОВЛЕНИЙ КРОК ---
    # Додали прапорець -p:GenerateResourceUsePreserializedResources=true
    - name: Publish EXE
      run: dotnet publish USRest_Admin/USRest_Admin.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:GenerateResourceUsePreserializedResources=true -o ./publish --no-restore

    - name: Zip Build
      run: |
        Compress-Archive -Path ./publish/* -DestinationPath AdminPanel.zip

    - name: Send to Telegram
      if: success()
      run: |
        curl -v -F "chat_id=${{ secrets.TELEGRAM_TO }}" `
             -F "caption= Admin Panel Build Success!" `
             -F "document=@AdminPanel.zip" `
             https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument